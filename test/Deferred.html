<!DOCTYPE HTML>
<html lang="en-US">
<head>
	<meta charset="UTF-8">
	<title>Deferred Unit Tests</title>
	<script type="text/javascript" src="util/doh/runner.js"></script>
	<script type="text/javascript" src="../when.js"></script>
	<script type="text/javascript">
		(function(global, doh) {

			doh.register('Promise', [
				function testResolve() {
					var dohd = new doh.Deferred();
					var d = when.Deferred();

					d.then(function(val) {
						dohd.callback(val);
					});

					d.resolve(true);

					return dohd;
				},
				function testReject() {
					var dohd = new doh.Deferred();
					var d = when.Deferred();

					d.then(
						function(val) { dohd.errback("Should have rejected"); },
						function(val) { dohd.callback(val); }
					);

					d.reject(true);

					return dohd;
				},
				function testProgress() {
					var dohd = new doh.Deferred();
					var d = when.Deferred();

					d.then(
						function(val) { dohd.errback("Should have progressed"); },
						function(val) { dohd.errback("Should have progressed"); },
						function(val) { dohd.callback(val); }
					);

					d.progress(true);

					return dohd;
				},
				function testThenAfterResolve() {
					var dohd = new doh.Deferred();
					var d = when.Deferred();

					d.resolve(true);

					d.then(function(val) {
						dohd.callback(val);
					});

					return dohd;
				},
				function testThenChain() {
					var dohd = new doh.Deferred();
					var d = when.Deferred();

					d.then(function(val) {
						
						return "second";

					}).then(function(val) {
						
						dohd.callback(val === "second");

					});

					d.resolve("first");

					return dohd;
				},
				function testThenForward() {
					var dohd = new doh.Deferred();
					var d = when.Deferred();

					d.then(function(val) {
						
						var d2 = when.Deferred();
						d2.resolve("second");
						return d2;

					}).then(function(val) {
						
						dohd.callback(val === "second");

					});

					d.resolve("first");

					return dohd;
				},
				function testThenForwardReject() {
					var dohd = new doh.Deferred();
					var d = when.Deferred();

					d.then(function(val) {
						
						var d2 = when.Deferred();
						d2.reject("second");
						return d2;

					}).then(
						function(val) { dohd.errback("Should have rejected"); },
						function(val) { dohd.callback(val === "second"); }
					);

					d.resolve("first");

					return dohd;
				}


			]);

			doh.run();
			
		})(window, doh);
	</script>
</head>
<body>
	
</body>
</html>